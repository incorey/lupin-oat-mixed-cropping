<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>intro</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="15-intro_files/libs/clipboard/clipboard.min.js"></script>
<script src="15-intro_files/libs/quarto-html/quarto.js"></script>
<script src="15-intro_files/libs/quarto-html/popper.min.js"></script>
<script src="15-intro_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="15-intro_files/libs/quarto-html/anchor.min.js"></script>
<link href="15-intro_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="15-intro_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="15-intro_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="15-intro_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="15-intro_files/libs/bootstrap/bootstrap-c0367b04c37547644fece4185067e4a7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>ToDo b4 sending to su/jo: add author affiliations, table size for easier legibility adapt graphical abstract numbers always use % not percent, cultivate not grow</p>
<p>Agricultural production both influences and is influenced by climate change. One strategy to mitigate this bidirectional impact is to diversify agricultural production <span class="citation" data-cites="lin2011">[@lin2011]</span>. By incorporating a wider range of crops alongside the primary staples, diversification enhances the resilience of agricultural systems to climate extremes <span class="citation" data-cites="renard2019">[@renard2019]</span>. Different crops exhibit varying physiological and ecological responses to environmental stressors, reducing the overall vulnerability and leading to greater yield stability compared to monoculture systems <span class="citation" data-cites="gaudin2015">[@gaudin2015]</span>.</p>
<p>Amongst the macronutrients fats, carbohydrates and proteins, proteins are the one that requires the highest amount of energy per weight unit to be synthesized <span class="citation" data-cites="tegeder2018 hildebrandt2015">[@tegeder2018; @hildebrandt2015]</span>. This high energy expenditure is attributed to the high nitrogen content of proteins, and the energy-intense metabolic pathways in the plant required to produce amino-acids <span class="citation" data-cites="tegeder2018 hildebrandt2015">[@tegeder2018; @hildebrandt2015]</span>. Additionally, producing nitrogen in a suitable form, either through the Haber-Bosch synthesis or the nitrogen-fixation, requires large amounts of energy <span class="citation" data-cites="erisman2008 vitousek2013">[@erisman2008; @vitousek2013]</span>.</p>
<p>Despite these costs to protein production, the protein demand is still rising and expected to grow at a rate of 8% per annum, which implies, further sustainable protein sources need to be opened <span class="citation" data-cites="ismail2020 kim2019 aschemann-witzel2021">[@ismail2020; @kim2019; @aschemann-witzel2021]</span>. In the of agricultural diversification and a growing protein demand, narrow-leaved lupins (NLLs) can play a relevant role in producing large amounts of sustainable protein <span class="citation" data-cites="lucas2015">[@lucas2015]</span>. Narrow-leaved lupins contain up to 40% of high-quality protein in their harvested grains, and their protein exhibits a high biological value, comparable to that of soy <span class="citation" data-cites="sedlakova2016 gresta2017 roman2023 muranyi2016">[@sedlakova2016; @gresta2017; @roman2023; @muranyi2016]</span>. NLLs obtain a large proportion of their protein-bound nitrogen from the atmosphere. They fix around 300 kilogram per hectare of atmospheric nitrogen and were documented to obtain above 90% of their nitrogen demand from atmospheric nitrogen <span class="citation" data-cites="palmason1992 evans1987 evans1987a">[@palmason1992; @evans1987; @evans1987a]</span>. Thus NLLs produce high amounts of quality-protein coupled to a low climate-impact.</p>
<p>In addition to diversifying agricultural production through the incorporation of different crop species, diversification can also be achieved by varying the production system itself. A successful approach thereto is to implement annual intercrops, where multiple species are co-cultivated in the same field. This type of intercropping was shown to result in more stable yields, compared to their monoculture equivalents <span class="citation" data-cites="raseduzzaman2017 huang2024">[@raseduzzaman2017; @huang2024]</span>. Mixed cropping, the spatiotemporally coincident cultivation of more than one crop in the same field has proven oneself to be an intercropping system that is particularly suitable to mechanised agriculture, since sowing, field management and harvesting can be performed in the same fashion as on monocrops <span class="citation" data-cites="mousavi2011">[@mousavi2011]</span>.</p>
<p>Particular attention has been drawn to the annual mixed cropping of pulses and cereals, a combination of crop families which leads to mutual benefit of both crops cultivated <span class="citation" data-cites="raseduzzaman2017 kumawat2022 rahman2022">[@raseduzzaman2017 @landschoot2024; @kumawat2022; @rahman2022]</span>. These intercrops exhibit a positive complementarity effect and elevated land use efficiencies, which arises when the mutual resource acquisition is greater than what would be expected from their respective monocrops <span class="citation" data-cites="li2020 loreau2001 oelbermann2015 kumawat2022 yu2015 brooker2015">[@li2020; @loreau2001; @oelbermann2015; @kumawat2022; @yu2015; @brooker2015]</span>. The resources used more efficiently by the pulse/cereal intercrops include soil nutrients and photosynthetically active radiation. This increased efficiency is explained by the crops different shoot and root architectures; the root system of cereals is often more extensive, while legume roots exhibit the ability to fix atmospheric nitrogen <span class="citation" data-cites="li2020 loreau2001 oelbermann2015 kumawat2022">[@li2020; @loreau2001; @oelbermann2015; @kumawat2022]</span>. Altogether, these complementary effects explain, why pulse/cereal intercrops exhibit higher yields than their monocrop equivalent in 74% of the recorded cases, and why pulse/cereal intercrops are the most common intercropping system applied <span class="citation" data-cites="verret2017 rao1987">[@verret2017; @rao1987]</span>.</p>
<p>The predominant improvement in productivity of pulse/cereal intercrops is also accompanied by healthier crops with regards to pest and weed pressure and disease infestations <span class="citation" data-cites="trenbath1993">[@trenbath1993]</span>. The underlying mechanism leading to reduced pest pressures is assumed to be owed to increased abundance of predators and parasites, and the host dilution effect through intercropping another species <span class="citation" data-cites="andow lithourgidis kumawat2022">[@andow; @lithourgidis; @kumawat2022]</span>. As a result, intercrops exhibited lower pest infestations in 52%, and higher infestations in 15% of the reported studies, compared with monocrops <span class="citation" data-cites="andow">[@andow]</span>. The trends in diseases is less clear than the improvement in pest infestation <span class="citation" data-cites="kumawat2022">[@kumawat2022]</span>. While the magnitude and direction and magnitude of this trend varies depending on the specific intercropping system, diseases involved, and environmental conditions, pulse/cereal intercropping generally still decreases the disease infestation by reducing their incidence and multiplication <span class="citation" data-cites="hauggaard-nielsen2008 malezieux2009">[@hauggaard-nielsen2008; @malezieux2009]</span>. Lastly, weed pressure is consistently lower in pulse/cereals intercrops than in their respective pulse monocrop, and in 52% of the studied cases, lower than their respective cereal monocrops <span class="citation" data-cites="verret2017">[@verret2017, @pradhan2022]</span>.</p>
<p>Pulse/cereal intercrops with oats as cereal partner are common, and particularly stand out due to the oats strong capacity to suppress weeds and the oats’ advantage in crop rotation that allows for cereal cultivation after the intercropping season <span class="citation" data-cites="rinke gronle2015 wang2012 staniak2014">[e.g. @rinke; @gronle2015; @wang2012; @staniak2014]</span>. Despite the multitude of meta-analyses and reviews evaluating the on-field characteristics and harvest performances of (pulse/cereal) intercrops, less information is available on yield quality in intercropping systems <span class="citation" data-cites="liu2023">[@liu2023]</span>. With regards to the protein yield, one meta-analysis by Li et al.&nbsp;2023 concluded that the protein yield of intercrops remains stable, compared to the more productive monocrop, given no nitrogen fertiliser is supplied <span class="citation" data-cites="li2023">[@li2023]</span>. Similarly, two studies by Begna et al.&nbsp;2021 and Liu et al.&nbsp;2023 assessed the forage quality of pulse/cereals intercrops, concluding either equivalent or improved feed quality in intercrops compared to their monocrop equivalents, respectively, which is partially also owed to the protein yields of the intercrops <span class="citation" data-cites="begna2021 liu2023">[@begna2021; @liu2023]</span>. Lastly, Bedoussac and Justes (2010) as well as Lauk and Lauk (2006) reported elevated grain protein contents in durum wheat intercropped with pulses, whereas Hauggaard-Nielsen et al.&nbsp;(2008) could not detect any effect on the barley protein content in intercropping with NLLs <span class="citation" data-cites="bedoussac2010 lauk hauggaard-nielsen2008">[@bedoussac2010; @lauk; @hauggaard-nielsen2008]</span>.</p>
<p>A large body of evidence thus supports the implementation of pulse/cereal intercrops, and many aspects of intercropping have been thoroughly assessed for main crops, which includes wheat, pea and maize <span class="citation" data-cites="landschoot2024">[@landschoot2024]</span>. However, studies on minor crops, such as NLL/oat intercrops are more limited <span class="citation" data-cites="kumawat2022 li2023 landschoot2024">[@kumawat2022; @li2023; @landschoot2024]</span>. Also, Dourmap et al.&nbsp;2025 pointed out the need to perform research on lupins to overcome its bottlenecks and unfold its full potential in the agricultural production system <span class="citation" data-cites="dourmap2025">[@dourmap2025]</span>. With regards to intercropping of minor crops, studies that evaluate and connect on-field performance, productivity and yield quality are underrepresented <span class="citation" data-cites="hauggaard-nielsen2008">[e.g. @hauggaard-nielsen2008]</span>, and to the best knowledge of the authors, no study has assessed these parameters across multiple NLL/oat variety combinations yet <span class="citation" data-cites="landschoot2024">[@landschoot2024]</span>.</p>
<p>This study evaluates on-field performance, productivity metrics and yield quality across multiple NLL/oat variety mixed crops and compares them to their respective monocrops. Compared with the monocrops, we expect the mixed crops to</p>
<ul>
<li>have less weeds, pests and diseases, i.e.&nbsp;the plants are healthier</li>
<li>show equal growth patterns as their monocrops, e.g.&nbsp;plant height or development stage</li>
<li>exhibit equal or improved land use and productivity</li>
<li>produce equal or higher amounts of protein per land area</li>
<li>display equal quality parameters (such as thousand kernel weight).</li>
</ul>
<section id="checks" class="level2">
<h2 class="anchored" data-anchor-id="checks">Checks</h2>
<p>From models M1-4: Isolate effect sizes and corresponding p-values from each. Multiply by the matrix</p>
<table class="caption-top table">
<colgroup>
<col style="width: 4%">
<col style="width: 12%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 4%">
<col style="width: 12%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 16%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">(Intercept)</th>
<th style="text-align: right;">y2022</th>
<th style="text-align: right;">sFall</th>
<th style="text-align: right;">lRe</th>
<th style="text-align: right;">y2022:sFall</th>
<th style="text-align: right;">y2022:lRe</th>
<th style="text-align: right;">sFall:lRe</th>
<th style="text-align: right;">y2022:sFall:lRe</th>
<th style="text-align: center;">y</th>
<th style="text-align: center;">s</th>
<th style="text-align: center;">l</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">85</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: center;">2022</td>
<td style="text-align: center;">Fall</td>
<td style="text-align: center;">Re</td>
</tr>
<tr class="even">
<td style="text-align: left;">181</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: center;">2022</td>
<td style="text-align: center;">Fall</td>
<td style="text-align: center;">Ta</td>
</tr>
<tr class="odd">
<td style="text-align: left;">277</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: center;">2022</td>
<td style="text-align: center;">Spring</td>
<td style="text-align: center;">Re</td>
</tr>
<tr class="even">
<td style="text-align: left;">373</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: center;">2022</td>
<td style="text-align: center;">Spring</td>
<td style="text-align: center;">Ta</td>
</tr>
<tr class="odd">
<td style="text-align: left;">469</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: center;">2023</td>
<td style="text-align: center;">Fall</td>
<td style="text-align: center;">Re</td>
</tr>
<tr class="even">
<td style="text-align: left;">565</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: center;">2023</td>
<td style="text-align: center;">Fall</td>
<td style="text-align: center;">Ta</td>
</tr>
<tr class="odd">
<td style="text-align: left;">661</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: center;">2023</td>
<td style="text-align: center;">Spring</td>
<td style="text-align: center;">Re</td>
</tr>
<tr class="even">
<td style="text-align: left;">757</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1</td>
<td style="text-align: center;">2023</td>
<td style="text-align: center;">Spring</td>
<td style="text-align: center;">Ta</td>
</tr>
</tbody>
</table>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>